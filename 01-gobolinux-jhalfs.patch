Subject: [PATCH] GoboLinux jhalfs patch

---
 BLFS/gen-makefile.sh              |  1 +
 BLFS/gen_pkg_book.sh              | 10 ++++++++++
 common/libs/func_check_version.sh |  2 +-
 common/libs/func_install_blfs     |  2 +-
 install-blfs-tools.sh             |  5 ++++-
 jhalfs                            | 10 ++++++++++
 6 files changed, 27 insertions(+), 3 deletions(-)

diff --git a/BLFS/gen-makefile.sh b/BLFS/gen-makefile.sh
index 9143c9e..108c610 100755
--- a/BLFS/gen-makefile.sh
+++ b/BLFS/gen-makefile.sh
@@ -40,6 +40,7 @@ __write_build_cmd() {              #
 #----------------------------------#
 (
 cat << EOF
+	mkdir -p logs
 	@${BUILD_SCRIPTS}/\$@ >logs/\$@ 2>&1
 EOF
 ) >> $MKFILE.tmp
diff --git a/BLFS/gen_pkg_book.sh b/BLFS/gen_pkg_book.sh
index 6d47325..b853925 100755
--- a/BLFS/gen_pkg_book.sh
+++ b/BLFS/gen_pkg_book.sh
@@ -163,6 +163,12 @@ source ${LibDir}/constants.inc
 source ${LibDir}/func_dependencies
 [[ $? > 0 ]] && echo -e "\n\tERROR: func_dependencies did not load..\n" && exit
 
+#---------------------
+# GoboLinux fixes
+source ${LibDir}/gobolinux_patch_buildscript
+[[ $? > 0 ]] && echo -e "\n\tERROR: gobolinux_patch_buildscript did not load..\n" && exit
+
+
 #------- MAIN --------
 if [[ ! -f ${PackFile} ]] ; then
   echo -e "\tNo packages file has been found.\n"
@@ -347,4 +353,8 @@ EOF
    cat head.tmp script.tmp tail.tmp >scripts/*${TARGET}
    rm *.tmp
 fi
+
+# Patch the scripts
+for i in ./scripts/*; do PatchBLFSScript "$i"; done
+
 #clean_configuration
diff --git a/common/libs/func_check_version.sh b/common/libs/func_check_version.sh
index 6f89072..14d299a 100644
--- a/common/libs/func_check_version.sh
+++ b/common/libs/func_check_version.sh
@@ -112,7 +112,7 @@ check_prerequisites() {      #
     check_version "$MIN_Glibc_VER"     "$(ldd --version  | head -n1 | awk '{print $NF}')"   "GLIBC"
   fi
   if [ -n "$MIN_Binutils_VER" ]; then
-    check_version "$MIN_Binutils_VER"  "$(ld --version  | head -n1 | awk '{print $NF}')"    "BINUTILS"
+    check_version "$MIN_Binutils_VER"  "$(ld --version | sed -n 's,.*Bin[^0-9]*\([0-9]*\.[0-9]*\).*,\1,p')"    "BINUTILS"
   fi
   if [ -n "$MIN_Tar_VER" ]; then
     check_version "$MIN_Tar_VER"       "$(tar --version | head -n1 | cut -d" " -f4)"        "TAR"
diff --git a/common/libs/func_install_blfs b/common/libs/func_install_blfs
index b481c76..3804ba4 100644
--- a/common/libs/func_install_blfs
+++ b/common/libs/func_install_blfs
@@ -207,7 +207,7 @@ ba
 d}' \
       $BUILDDIR$BLFS_ROOT/scripts/*docbook-xsl
 fi
-if [ "$DEP_SUDO" = y ]; then
+if [ "$DEP_SUDO" = y ] && [ $(stat $BUILDDIR$BLFS_ROOT/scripts/*sudo &> /dev/null) ]; then
   sed -i '/cat.*pam.d/i mkdir -p /etc/pam.d' $BUILDDIR$BLFS_ROOT/scripts/*sudo
 fi
 # At last generates the build Makefile
diff --git a/install-blfs-tools.sh b/install-blfs-tools.sh
index 28d0997..2e5aa26 100755
--- a/install-blfs-tools.sh
+++ b/install-blfs-tools.sh
@@ -80,7 +80,7 @@ fi
 COMMON_DIR="common"
 # blfs-tool envars
 BLFS_TOOL='y'
-BUILDDIR=$(cd ~;pwd)
+BUILDDIR="$WORKDIR/RootFS"
 BLFS_ROOT="${BLFS_ROOT:=/blfs_root}"
 TRACKING_DIR="${TRACKING_DIR:=/var/lib/jhalfs/BLFS}"
 INITSYS="${INITSYS:=sysv}"
@@ -171,6 +171,9 @@ cp -a $LFS_BOOK $BUILDDIR$BLFS_ROOT/$LFS_XML
 [[ $VERBOSITY > 0 ]] && echo "... OK"
 }
 
+# Replace the default configuration file with the Gobo-ALFS one.
+cp configuration.blfs ${BUILDDIR}${BLFS_ROOT}/configuration
+
 [[ $VERBOSITY > 0 ]] && echo "Initializing the BLFS tool directory "
 make -j1 -C $BUILDDIR$BLFS_ROOT \
      TRACKING_DIR=$TRACKING_DIR \
diff --git a/jhalfs b/jhalfs
index 8862d7d..6b41282 100755
--- a/jhalfs
+++ b/jhalfs
@@ -382,6 +382,16 @@ if [[ "$REBUILD_MAKEFILE" = "n" ]] ; then
 # Note that all customization to $JHALFSDIR have to be done before this.
 # But the LFS book is needed for BLFS tools.
   get_book
+  BOOK_PATCH_FILE=$CWD/custom/02-gobolinux-book.patch
+  DEVTREE=$JHALFSDIR/lfs-development
+  if [ -d "$DEVTREE" -a ! -e "$DEVTREE/.patched-gobolinux" ]
+  then
+      pushd "$DEVTREE" >& /dev/null
+      echo "Applying patch $BOOK_PATCH_FILE to $PWD"
+      patch -i "$BOOK_PATCH_FILE" -p0
+      touch .patched-gobolinux
+      popd >& /dev/null
+  fi
   extract_commands
   echo "${SD_BORDER}${nl_}"
   cd "$CWD" # the functions above change directory
-- 
2.51.0

